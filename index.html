<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDB Viewer with STL Export</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/STLExporter.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 8px;
      z-index: 1;
      max-width: 400px;
    }
    #instructions {
      font-size: 12px;
      margin-top: 10px;
      background: #f0f0f0;
      padding: 8px;
      border-radius: 6px;
    }
    input[type="text"] {
      width: 100%;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="pdbFile" /><br />

    <input type="text" id="pdbId" placeholder="Enter PDB ID (e.g. 1CRN)" />
    <button onclick="loadPDBbyId()">Load by ID</button><br />

    <input type="text" id="pdbUrl" placeholder="Paste raw PDB file URL here" />
    <button onclick="loadPDBfromURL()">Load from URL</button><br />

    <button onclick="exportSTL()">Export STL</button><br><br>

    <label><input type="checkbox" id="showAtoms" checked> Show Atoms</label><br>
    <label><input type="checkbox" id="showBonds" checked> Show Bonds</label><br>
    <label><input type="checkbox" id="showRibbon" checked> Show Ribbon</label><br>
    <label>Bond Distance: <input type="range" id="bondThreshold" min="1" max="2" step="0.1" value="1.6"></label><br>

    <div id="instructions">
      <strong>ðŸ§¬ Raw PDB File Instructions:</strong><br>
      Use only <em>raw direct links</em> to .pdb files.<br>
      Example format:<br>
      <code>https://files.rcsb.org/view/XXXX.pdb</code><br>
      Replace <code>XXXX</code> with a valid PDB ID like <code>1CRN</code> or <code>1MBN</code>.<br><br>
      Or just enter the ID above and click <strong>"Load by ID"</strong> ðŸ˜Š
    </div>
  </div>

  <script>
    function loadPDBbyId() {
      const id = document.getElementById("pdbId").value.trim().toUpperCase();
      if (!id || id.length !== 4) {
        alert("Please enter a valid 4-letter PDB ID like '1CRN'.");
        return;
      }
      const url = `https://files.rcsb.org/view/${id}.pdb`;
      document.getElementById("pdbUrl").value = url;
      loadPDBfromURL();
    }

    function loadPDBfromURL() {
      const url = document.getElementById("pdbUrl").value;
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error("File not found");
          return res.text();
        })
        .then(text => parsePDB(text))
        .catch(err => alert("Failed to load PDB: " + err));
    }

    function exportSTL() {
      const exporter = new THREE.STLExporter();
      const stl = exporter.parse(scene);
      const blob = new Blob([stl], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'protein_model.stl';
      link.click();
    }

    // Dummy functions â€” insert your existing 3D viewer JS here:
    let scene = new THREE.Scene();
    function parsePDB(text) { alert("PDB file loaded. (Add real 3D parsing here.)"); }
  </script>
</body>
</html>
